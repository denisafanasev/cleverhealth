{% extends 'base.html' %}

{% block main_block %}

    <script src="{{ url_for('static' , filename="js/datatables.js") }}"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // DataTables with Buttons
            var datatablesButtons = $("#datatables-buttons").DataTable({
                responsive: true,
                lengthChange: !1,

            });
            datatablesButtons.buttons().container().appendTo("#datatables-buttons_wrapper .col-md-6:eq(0)");

            {% for item in _data_now %}
                var modal_{{ item['user_id'] }} = document.getElementById('{{ item['user_id'] }}');
                {% if _mode[item['user_id']] == "edit" %}
                    modal_{{ item['user_id'] }}.style.display = "block";
                {% endif %}
            {% endfor %}
        });
    </script>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
        }


        img.avatar {
            width: 40%;
            border-radius: 50%;
        }

        span.psw {
            float: right;
            padding-top: 16px;
        }

        .pagination {
            z-index: 0;
        }

        /* The Modal (background) */
        .modal {
            display: none; /* Hidden by default */
            z-index: 99; /* Sit on top */
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0, 0, 0); /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
            {#padding-top: 60px;#}
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        /* Modal Content/Box */
        .modal-content {

            margin: 5% auto 15% auto; /* 5% from the top, 15% from the bottom and centered */
            border: gray;
            width: 80%; /* Could be more or less, depending on screen size */
            padding: 16px;
        }

        .modal-backdrop{
            display: none;
        }
        /* The Close Button (x) */

        .close:hover,
        .close:focus {
            color: red;
            cursor: pointer;
        }

        /* Add Zoom Animation */
        .animate {
            -webkit-animation: animatezoom 0.6s;
            animation: animatezoom 0.6s
        }

        @-webkit-keyframes animatezoom {
            from {
                -webkit-transform: scale(0)
            }
            to {
                -webkit-transform: scale(1)
            }
        }

        @keyframes animatezoom {
            from {
                transform: scale(0)
            }
            to {
                transform: scale(1)
            }
        }

        /* Change styles for span and cancel button on extra small screens */
        @media screen and (max-width: 300px) {
            span.psw {
                display: block;
                float: none;
            }
            .cancelbtn {
                width: 100%;
            }
        }
    </style>

    <div class="container-fluid p-0">

        <h1 class="h3 mb-3">Управление пользователями</h1>

        <div class="row">
            <div class="col-12">
                <div class="card border">
                    <div class="card-body">
                        <div id="datatables-buttons_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">

                            {% if _is_current_user_admin %}
                                <div class="row">
                                    <div class="col-sm-12 col-md-6">
                                        <div class="dt-buttons btn-group flex-wrap">
                                            <a class="btn btn-secondary buttons-copy buttons-html5" aria-controls="datatables-buttons"
                                            data-bs-toggle="modal" data-bs-target="#0"
                                                    onclick="document.getElementById('0').style.display='block'">
                                                <span>Добавить пользователя</span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <div class="row">
                                <div class="col-sm-12">
                                    <table id="datatables-buttons" class="table table-striped dataTable no-footer dtr-inline" style="width: 100%;" role="grid" aria-describedby="datatables-buttons_info">
                                        <thead>
                                        <tr role="row">
                                            <th style="width:5%;">#</th>
                                            <th class="sorting" tabindex="0" aria-controls="datatables-buttons" rowspan="1" colspan="1"
                                                style="width:10%;" aria-label="Position: activate to sort column ascending">Login
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="datatables-buttons" rowspan="1" colspan="1"
                                                style="width:20%;" aria-label="Position: activate to sort column ascending">Имя пользователя
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="datatables-buttons" rowspan="1" colspan="1"
                                                style="width:10%;" aria-label="Position: activate to sort column ascending">Email
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="datatables-buttons" rowspan="1" colspan="1"
                                                style="width:10%;" aria-label="Position: activate to sort column ascending">Роль
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="datatables-buttons" rowspan="1" colspan="1"
                                                style="width:5%;" aria-label="Position: activate to sort column ascending">Тестируемые
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="datatables-buttons" rowspan="1" colspan="1"
                                                style="width:15%;" aria-label="Position: activate to sort column ascending">Дата создания
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="datatables-buttons" rowspan="1" colspan="1"
                                                style="width:15%;" aria-label="Position: activate to sort column ascending">Срок доступа
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="datatables-buttons" rowspan="1" colspan="1"
                                                style="width:5%;" aria-label="Position: activate to sort column ascending">Статус
                                            </th>
{#                                            <th class="sorting" tabindex="0" aria-controls="datatables-buttons" rowspan="1" colspan="1"#}
{#                                                style="width:5%;" aria-label="Position: activate to sort column ascending">#}
{#                                            </th>#}
                                        </tr>
                                        </thead>
                                        <tbody>

                                        {% for item in _data_now %}
                                            {% if item["user_id"] %}
                                            <tr class="even">

                                                <td><img src="{{ url_for('static' , filename="img/avatars/149071.jpg") }}" width="32" height="32" class="rounded-circle my-n1" alt="Avatar"></td>

                                                <td class="sorting_1 dtr-control">
                                                    <a href="#" data-bs-toggle="modal" data-bs-target="#{{ item['user_id'] }}"
                                                    onclick="document.getElementById('{{ item['user_id'] }}').style.display='block'">{{ item['login'] }}</a>
                                                </td>
                                                <td>{{ item['name'] }}</td>
                                                <td>{{ item['email'] }}</td>
                                                <td>{{ item['role'] }}</td>
                                                <td>{{ item['probationers_number'] }}</td>
                                                <td>{{ item['created_date'] }}</td>
                                                <td><a href="#" data-bs-toggle="modal" data-bs-target="#extension_{{ item['user_id'] }}"
                                                       onclick="document.getElementById('extension_{{ item['user_id'] }}').style.display='block';">{{ item['education_module_expiration_date'] }}</a></td>

                                                {% if item['is_active'] %}
                                                    <td><span class="badge bg-success"><a data-bs-toggle="modal" data-bs-target="#extension_{{ item['user_id'] }}"
                                                                                          onclick="document.getElementById('status_{{ item['user_id'] }}').style.display='block';">Active</a></span></td>
                                                {% else %}
                                                    <td><span class="badge bg-warning"><a data-bs-toggle="modal" data-bs-target="#extension_{{ item['user_id'] }}"
                                                                                          onclick="document.getElementById('status_{{ item['user_id'] }}').style.display='block';">Inactive</a></span></td>
                                                {% endif %}
{#                                                <td>#}
{#                                                    <button onclick="document.getElementById('{{ item['user_id'] }}').style.display='block'"#}
{#                                                            style="width:auto;" class="btn btn-primary">#}
{#                                                        Login#}
{#                                                    </button>#}
{#                                                </td>#}

                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% for item in _data_now %}
            <script>
                // Get the modal
                var modal_{{ item['user_id'] }} = document.getElementById('{{ item['user_id'] }}');
                var modal_extension_{{ item['user_id'] }} = document.getElementById('extension_{{ item['user_id'] }}');
                var modal_status_{{ item['user_id'] }} = document.getElementById('status_{{ item['user_id'] }}');
                var modal_discharge_{{ item['user_id'] }} = document.getElementById('status_{{ item['user_id'] }}');
                // When the user clicks anywhere outside of the modal, close it
                window.onclick = function (event) {
                    if (event.target === modal_{{ item['user_id'] }}) {
                        modal_{{ item['user_id'] }}.style.display = "none";
                    }
                    if (event.target === modal_extension_{{ item['user_id'] }}) {
                        modal_extension_{{ item['user_id'] }}.style.display = "none";
                    }
                    if (event.target === modal_extension_{{ item['user_id'] }}) {
                        modal_status_{{ item['user_id'] }}.style.display = "none";
                    }
                    if (event.target === modal_extension_{{ item['user_id'] }}) {
                        modal_discharge_{{ item['user_id'] }}.style.display = "none";
                    }
                }
            </script>
            <div id="{{ item['user_id'] }}" class="modal_{{ item['user_id'] }} modal">
                <div class="modal-content animate">
                    <h3 class="modal-title">{% if _mode[item['user_id']] == "view" %}Просмотр{% else %} Редактирование{% endif %} карточки пользователя</h3>
                    <form id="add_user" name="add_user" method="post" class="was-validated" enctype="multipart/form-data" onsubmit="return checkPassword(this);">
                    <div class="row d-flex align-items-stretch bd-highlight">

                        <div style="margin-right: 5px" class="col p-1 bd-highlight border">
                            <div class="card d-flex align-self-baseline" style="height: 100%;">
                                <div class="card-header">
                                    <h5 class="card-title">Учетные данные пользователя</h5>

                                    <div class="mb-2">
                                        <label class="form-label"><strong>Login</strong></label>
                                        <input required type="text" name="login_{{ item['user_id']|int }}" class="form-control" {% if _mode[ item['user_id']|int]!="new" %}readonly {% endif %}
                                                {% if _data_edit[ item['user_id']|int]['login'] != _data[ item['user_id']|int]['login'] or _mode[ item['user_id']|int] != "new" %}value="{{ _data_edit[ item['user_id']|int]['login'] }}" {% else %}
                                               placeholder="Введите логин пользователя" {% endif %}>
                                        <div class="invalid-feedback">
                                            Поле, обязательное для заполнения!
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <label class="form-label"><strong>Имя
                                            пользователя</strong></label>
                                        <input required type="text" name="user_name_{{ item['user_id']|int }}" class="form-control" {% if _mode[ item['user_id']|int]=="view" or _mode[ item['user_id']|int]=="discharge" %}readonly {% endif %}
                                                {% if _data_edit[ item['user_id']|int]['name'] != _data[ item['user_id']|int]['name'] or _mode[ item['user_id']|int] != "new" %} value="{{ _data_edit[ item['user_id']|int]['name'] }}" {% else %}
                                               placeholder="Введите имя пользователя" {% endif %}>
                                        <div class="invalid-feedback">
                                            Поле, обязательное для заполнения!
                                        </div>
                                    </div>

                                    {% if _mode[ item['user_id']|int]=="new" or _mode[ item['user_id']|int]=="discharge" %}
                                        <div class="mb-2">
                                            <label class="form-label"><strong>Пароль</strong></label>
                                            <input required type="password" name="password_{{ item['user_id']|int }}" class="form-control"{% if _data_edit[ item['user_id']|int]['password']!= _data[ item['user_id']|int]['password'] %}
                                                   value="{{ _data_edit[ item['user_id']|int]['password'] }}" {% else %}placeholder="Введите пароль" {% endif %}>
                                            <div class="invalid-feedback">
                                                Поле, обязательное для заполнения!
                                            </div>
                                        </div>

                                        <div class="mb-2">
                                            <label class="form-label"><strong>Повтор пароля</strong></label>
                                            <input required type="password" name="password2_{{ item['user_id']|int }}" class="form-control"{% if _data_edit['password2']!= _data['password2'] %}
                                                   value="{{ _data_edit['password2'] }}" {% else %}placeholder="Повторно введите пароль" {% endif %}>
                                            <div class="invalid-feedback">
                                                Поле, обязательное для заполнения!
                                            </div>
                                        </div>
                                    {% endif %}

                                    <div class="mb-2">
                                        <label class="form-label"><strong>Email</strong></label>
                                        <input required type="email" name="email_{{ item['user_id']|int }}" class="form-control"{% if _mode[ item['user_id']|int]=="view" or _mode[ item['user_id']|int]=="discharge" %} readonly {% endif %}
                                                {% if _data_edit[ item['user_id']|int]['email'] != _data[ item['user_id']|int]['email'] or _mode[ item['user_id']|int] != "new" %}value="{{ _data_edit[ item['user_id']|int]['email'] }}" {% else %}placeholder="Введите email пользователя" {% endif %}>
                                        <div class="invalid-feedback">
                                            Поле, обязательное для заполнения!
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col p-1 bd-highlight border">

                            <div class="card d-flex align-self-baseline" style="height: 100%;">

                                <div class="card-header">
                                    <h5 class="card-title">Параметры доступа</h5>
                                    <div class="mb-2">
                                        <label class="form-label"><strong>Роль пользователя</strong></label>
                                        <select required type="text" name="role_{{ item['user_id'] }}" class="form-select"
                                                {% if _mode[ item['user_id']|int]=="view" or _mode[ item['user_id']|int]=="discharge" %}disabled {% endif %}>
                                            {% if _mode[ item['user_id']|int] != "view" %}
                                                <option value="">Выберите роль пользователя
                                                </option>
                                                {% for i in _settings['role'] %}
                                                    <option {% if i == _data_edit[ item['user_id']|int]['role'] %}selected {% endif %}value="{{ i }}">{{ i }}</option>
                                                {% endfor %}
                                            {% else %}
                                                <option>{{ _data_edit[ item['user_id']|int]['role'] }}</option>
                                            {% endif %}
                                        </select>
                                        <div class="invalid-feedback">
                                            Поле, обязательное для заполнения!
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <label class="form-label"><strong>Количество доступных тестируемых</strong></label>
                                        <select required type="text" name="probationers_number_{{ item['user_id'] }}" class="form-select" {% if _mode[ item['user_id']|int]=="view" or [ item['user_id']|int]=="discharge" %}disabled {% endif %}>
                                            {% if _mode[ item['user_id']|int] != "view" %}
                                                <option value="">Выберите количество доступных тестируемых</option>
                                                {% for i in _settings['probationers_number'] %}
                                                    <option{% if _data_edit[ item['user_id']|int]['probationers_number'] == i %} selected {% endif %} value="{{ i }}">{{ i }}</option>
                                                {% endfor %}
                                            {% else %}
                                                <option>{{ _data_edit[ item['user_id']|int]['probationers_number'] }}</option>
                                            {% endif %}
                                        </select>
                                        <div class="invalid-feedback">
                                            Поле, обязательное для заполнения!
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row d-flex align-items-stretch bd-highlight" align="right">
                        <div class="col-12 p-2">
                            {% if _mode[ item['user_id']|int] !="discharge" %}
                                <button type="submit" name="button_{{ item['user_id']|int }}" value="{% if _mode[ item['user_id']|int]=="new" %}add{% elif _mode[ item['user_id']|int]=="edit" %}save{% else %}edit{% endif %}" class="btn btn-primary ">
                                    {% if _mode[ item['user_id']|int]=="new" %}Добавить пользователя
                                    {% elif _mode[ item['user_id']|int]=="edit" %}Сохранить
                                    {% else %}Редактировать
                                    {% endif %}
                                </button>
                            {% endif %}
                            {% if _mode[ item['user_id']|int] == "view" %}
                                <a type="submit" href="#" data-bs-toggle="modal" data-bs-target="#discharge_{{ item['user_id'] }}"
                                                                                          onclick="document.getElementById('{{ item['user_id'] }}').style.display='none';
                                                                                          document.getElementById('discharge_{{ item['user_id'] }}').style.display='block';" class="btn btn-primary">Сброс пароля
                                </a>
                            {% endif %}
                            <a onclick="document.getElementById('{{ item['user_id'] }}').style.display='none'" type="submit" name="button" class="btn btn-primary cancelbtn">
                                Отмена
                            </a>
                        </div>
                    </div>
                </form>
                </div>
            </div>
            <div id="extension_{{ item['user_id'] }}" class="modal_{{ item['user_id'] }} modal">
                <div class="modal-content animate" style="width: 31%">
                    <h3 class="modal-title">Доступ к центру обучения</h3>
                    <form id="form" name="form" method="post" enctype="multipart/form-data">
                        <div class="row d-flex align-items-stretch bd-highlight">
                            <div class="card d-flex align-self-baseline border" style="margin-left: auto; margin-right: auto;">
                                <div class="card-header">
                                    <div class="mb-2">

                                        <label class="form-label"><strong>Продление срока доступа</strong></label>
                                        <select required class="form-select" name="period_{{ item['user_id']|int }}">
                                            <option selected disabled value="">
                                                Выберите продление срок доступа..
                                            </option>
                                            {% for i in _settings['education_module_expiration_date'] %}
                                                <option value="{{ i['amount'] }}">{{ i['name_period'] }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-2">
                                        <select required name="reference_point_{{ item['user_id']|int }}" class="form-select">
                                            <option selected disabled value="">
                                                Выберите начальное время отсчета..
                                            </option>
                                            {% for i_point in _settings['reference_point'] %}
                                                <option value="{{ i_point['value'] }}">{{ i_point['name_point'] }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row d-flex align-items-stretch bd-highlight" align="right">
                            <div class="p-1">
                                <button type="submit" class="btn btn-primary " name="button_{{ item['user_id']|int }}" value="extension">
                                    Продлить
                                </button>
                                <a onclick="document.getElementById('extension_{{ item['user_id'] }}').style.display='none'" type="submit" name="button" class="btn btn-primary cancelbtn">
                                    Отмена
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div id="status_{{ item['user_id'] }}" class="modal_{{ item['user_id'] }} modal" >
                <div class="modal-content animate" style="width: 20%">
                <h3 class="modal-title">Статус пользователя</h3>
                    <form id="status_user" name="status_user" method="post" enctype="multipart/form-data">
                        <div class="card d-flex align-self-baseline border" style="margin-left: auto; margin-right: auto; ">
                            <div class="card-header">
                                <div class="mb-2">
                                    <label class="form-label" style="height: 100%"><strong>Статус</strong></label>
                                    <div>
                                        <input id="is_active" name="is_active_{{ item['user_id']|int }}"
                                               class="form-check-input" type="checkbox" value="True"
                                               {% if _data_edit[item['user_id']]['active'] %}checked{% endif %}>
                                        <label class="form-check-label" for="is_active">Разблокирован</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row d-flex align-items-stretch bd-highlight" style="margin-left: auto; margin-right: auto; ">
                            <div class="p-2" align="right">
                            <button class="btn btn-primary" name="button_{{ item['user_id']|int }}" value="is_active">Сохранить</button>
                            <a onclick="document.getElementById('status_{{ item['user_id'] }}').style.display='none'" type="submit" class="btn btn-primary cancelbtn">
                                Отмена
                            </a>
                        </div>
                        </div>
                    </form>
                </div>
            </div>
            <div id="discharge_{{ item['user_id'] }}" class="modal_{{ item['user_id'] }} modal" >
                <div class="modal-content animate" style="width: 20%">
                    <h3 class="modal-title">Сброс пароля</h3>
                    <form id="status_user" name="status_user" method="post" enctype="multipart/form-data">
                        <div class="card d-flex align-self-baseline border" style="margin-left: auto; margin-right: auto; ">
                            <div class="card-header">
                                <div class="mb-2">
                                    <label class="form-label"><strong>Пароль</strong></label>
                                    <input required type="password" name="password_{{ item['user_id']|int }}_{{ item['user_id']|int }}" class="form-control"{% if _data_edit[ item['user_id']|int]['password']!= _data[ item['user_id']|int]['password'] %}
                                           value="{{ _data_edit[ item['user_id']|int]['password'] }}" {% else %}placeholder="Введите пароль" {% endif %}>
                                    <div class="invalid-feedback">
                                        Поле, обязательное для заполнения!
                                    </div>
                                </div>

                                <div class="mb-2">
                                    <label class="form-label"><strong>Повтор пароля</strong></label>
                                    <input required type="password" name="password2_{{ item['user_id']|int }}_{{ item['user_id']|int }}" class="form-control"{% if _data_edit['password2']!= _data['password2'] %}
                                           value="{{ _data_edit['password2'] }}" {% else %}placeholder="Повторно введите пароль" {% endif %}>
                                    <div class="invalid-feedback">
                                        Поле, обязательное для заполнения!
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row d-flex align-items-stretch bd-highlight" style="margin-left: auto; margin-right: auto; ">
                            <div class="p-1" align="right">
                            <button type="submit" name="button_{{ item['user_id']|int }}" value="discharge" class="btn btn-primary ">
                                Сохранить
                            </button>
                            <a onclick="document.getElementById('discharge_{{ item['user_id'] }}').style.display='none'" type="submit" class="btn btn-primary cancelbtn">
                                Отмена
                            </a>
                        </div>
                        </div>
                    </form>
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}